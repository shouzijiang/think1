# 久坐提醒小程序 - 后端开发说明

## 项目概述

本项目是基于 ThinkPHP 8 开发的久坐提醒小程序后端 API，实现了用户认证、打卡记录、用户设置、订阅消息等功能。

## 已完成功能

### 1. 用户认证模块
- ✅ 微信登录接口 (`POST /auth/wechat/login`)
- ✅ 更新用户信息接口 (`POST /auth/user/update`)
- ✅ JWT Token 认证中间件

### 2. 打卡模块
- ✅ 提交打卡记录 (`POST /punch/submit`)
- ✅ 获取打卡记录列表 (`GET /punch/records`)
- ✅ 获取打卡统计数据 (`GET /punch/statistics`)
- ✅ 连续打卡天数计算

### 3. 用户设置模块
- ✅ 保存用户设置 (`POST /settings/save`)
- ✅ 获取用户设置 (`GET /settings/get`)

### 4. 订阅消息模块
- ✅ 保存订阅消息授权 (`POST /subscribe/save`)
- ✅ 定时任务发送提醒消息 (`GET /cron/send-remind`)

## 项目结构

```
tp/
├── app/
│   ├── controller/          # 控制器
│   │   ├── Auth.php         # 认证控制器
│   │   ├── Punch.php        # 打卡控制器
│   │   ├── Settings.php     # 设置控制器
│   │   ├── Subscribe.php    # 订阅消息控制器
│   │   └── Cron.php         # 定时任务控制器
│   ├── service/             # 服务层
│   │   ├── AuthService.php
│   │   ├── PunchService.php
│   │   ├── SettingsService.php
│   │   ├── SubscribeService.php
│   │   └── CronService.php
│   ├── model/               # 模型
│   │   ├── User.php
│   │   ├── PunchRecord.php
│   │   ├── UserSetting.php
│   │   ├── UserSubscribe.php
│   │   └── MessageLog.php
│   ├── common/              # 公共类
│   │   ├── JwtHelper.php    # JWT工具类
│   │   ├── WechatHelper.php # 微信API工具类
│   │   └── ResponseHelper.php # 响应格式化工具类
│   └── middleware/          # 中间件
│       └── Auth.php         # JWT认证中间件
├── route/
│   └── app.php              # 路由配置
├── config/
│   ├── database.php         # 数据库配置
│   └── middleware.php       # 中间件配置
└── md/                      # 文档目录
    ├── API接口文档.md
    ├── 接口清单.md
    ├── 后端开发指南.md
    └── database.sql
```

## 环境配置

### 1. 复制环境配置文件

```bash
cp .example.env .env
```

### 2. 配置环境变量

编辑 `.env` 文件，配置以下内容：

```env
# 数据库配置
DB_TYPE = mysql
DB_HOST = 127.0.0.1
DB_NAME = standup_app
DB_USER = root
DB_PASS = your_password
DB_PORT = 3306
DB_CHARSET = utf8mb4

# 微信小程序配置
WECHAT_APPID = your_appid_here
WECHAT_SECRET = your_secret_here

# JWT密钥（请修改为随机字符串，建议32位以上）
JWT_SECRET = your-jwt-secret-key-change-in-production
```

### 3. 创建数据库

执行 `md/database.sql` 文件创建数据库表结构。

## 路由配置

所有 API 路由已配置在 `route/app.php` 文件中：

- **公开接口**（不需要认证）：
  - `POST /auth/wechat/login` - 微信登录
  - `GET /cron/send-remind` - 定时任务（内部调用）

- **需要认证的接口**（需要 JWT Token）：
  - `POST /auth/user/update` - 更新用户信息
  - `POST /punch/submit` - 提交打卡
  - `GET /punch/records` - 获取打卡记录
  - `GET /punch/statistics` - 获取统计数据
  - `POST /settings/save` - 保存设置
  - `GET /settings/get` - 获取设置
  - `POST /subscribe/save` - 保存订阅消息授权

## 使用 JWT Token

### 获取 Token

通过微信登录接口获取：

```bash
POST /auth/wechat/login
Content-Type: application/json

{
  "code": "081xxxxxx"
}
```

响应：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user_id": 123,
    "expires_in": 7200
  }
}
```

### 使用 Token

在需要认证的接口请求头中携带：

```
Authorization: Bearer {token}
```

## 定时任务配置

### Linux Crontab

```bash
# 每5分钟执行一次提醒任务
*/5 * * * * /usr/bin/php /path/to/tp/think cron:send-remind
```

### 手动执行

```bash
php think cron:send-remind
```

或者通过 HTTP 请求：

```bash
GET /cron/send-remind
```

## 接口测试

### 使用 curl 测试

#### 1. 微信登录
```bash
curl -X POST http://localhost:8000/auth/wechat/login \
  -H "Content-Type: application/json" \
  -d '{"code":"081xxxxxx"}'
```

#### 2. 提交打卡（需要 Token）
```bash
curl -X POST http://localhost:8000/punch/submit \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{"timestamp":1704067200000}'
```

#### 3. 获取打卡记录
```bash
curl -X GET "http://localhost:8000/punch/records?page=1&page_size=20" \
  -H "Authorization: Bearer {token}"
```

## 注意事项

1. **安全性**：
   - JWT_SECRET 要使用随机字符串，不要泄露
   - 所有用户输入都要验证和过滤
   - 使用 PDO 预处理语句防止 SQL 注入（ThinkPHP ORM 已自动处理）

2. **性能**：
   - access_token 已使用缓存，避免频繁请求
   - 数据库查询已使用索引
   - 可以考虑使用 Redis 缓存统计数据

3. **错误处理**：
   - 所有接口都有错误处理
   - 记录错误日志
   - 微信接口调用失败会记录日志

4. **测试**：
   - 在开发环境充分测试
   - 使用微信开发者工具测试
   - 测试各种异常情况

## 开发规范

1. **控制器**：只负责接收请求和返回响应，业务逻辑放在 Service 层
2. **Service 层**：处理业务逻辑，调用 Model 进行数据操作
3. **Model 层**：定义数据模型和关联关系
4. **响应格式**：统一使用 `ResponseHelper` 格式化响应

## 常见问题

### Q: Token 过期时间？
A: 2小时，过期后需要重新登录。

### Q: 打卡记录保存多久？
A: 建议永久保存，或根据业务需求设置保留期限。

### Q: 定时任务执行频率？
A: 建议每5-10分钟执行一次。

### Q: access_token 有效期？
A: 2小时，已实现缓存并提前刷新。

## 更新日志

### 2024-01-01
- ✅ 完成所有核心功能开发
- ✅ 配置路由和中间件
- ✅ 修复控制器构造函数问题
- ✅ 更新环境配置文件
- ✅ 优化 JWT 密钥配置

## 后续优化建议

1. 添加接口限流
2. 添加请求日志记录
3. 添加单元测试
4. 优化数据库查询性能
5. 添加 Redis 缓存支持
6. 添加接口文档（Swagger）

